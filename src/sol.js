// benchmark.js

// 10MBã®å·¨å¤§ãªæ–‡å­—åˆ—ã‚’ä½œæˆ (ãƒ¡ãƒ¢ãƒªè² è·ã‚’ã‚ã‹ã‚Šã‚„ã™ãã™ã‚‹ãŸã‚)
// â€» åŠè§’è‹±æ•°ã¯1æ–‡å­—1ãƒã‚¤ãƒˆã§ã™ãŒã€JSã®æ–‡å­—åˆ—ã¯å†…éƒ¨çš„ã«UTF-16ãªã®ã§ã€
//   1000ä¸‡æ–‡å­—ã¯ å®Ÿãƒ¡ãƒ¢ãƒªã§ç´„20MBã€œã‚’æ¶ˆè²»ã—ã¾ã™ã€‚
const heavyString =
  "a".repeat(5 * 1024 * 1024) + "xyz123" + "b".repeat(5 * 1024 * 1024);

// ----------------------------------------------------
// 1. Stackç‰ˆ (æ–‡å­—åˆ—ã‚³ãƒ”ãƒ¼ã‚ã‚Š)
// ----------------------------------------------------
function testStack(s) {
  const startMem = process.memoryUsage().heapUsed;

  // ã“ã“ã§å·¨å¤§ãªã‚³ãƒ”ãƒ¼ãŒç™ºç”Ÿï¼
  const cleanStr = s.toLowerCase().replace(/[^a-z0-9]/g, "");
  const stack = [];
  // ã“ã“ã§ã•ã‚‰ã«é…åˆ—ã®ãƒ¡ãƒ¢ãƒªç¢ºä¿ï¼
  for (let i = 0; i < cleanStr.length / 2; i++) {
    stack.push(cleanStr[i]);
  }

  // è¨ˆæ¸¬ã®ãŸã‚ã«ã€å‡¦ç†ä¸­ã®ã€Œãƒ”ãƒ¼ã‚¯æ™‚ã€ã«è¿‘ã„çŠ¶æ…‹ã‚’æ“¬ä¼¼çš„ã«æ¸¬ã‚‹
  // (é–¢æ•°ã‚’æŠœã‘ã‚‹ã¨GCå¯¾è±¡ã«ãªã£ã¦ã—ã¾ã†ãŸã‚ã€å‡¦ç†ä¸­ã«æ¸¬ã‚‹ã®ãŒãƒã‚¤ãƒ³ãƒˆ)
  const currentMem = process.memoryUsage().heapUsed;

  // å®Ÿéš›ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆçœç•¥ã—ã¦ã‚‚ãƒ¡ãƒ¢ãƒªç¢ºä¿ã¯çµ‚ã‚ã£ã¦ã„ã‚‹ï¼‰
  // ...

  return currentMem - startMem; // å¢—ãˆãŸåˆ†ã‚’è¿”ã™
}

// ----------------------------------------------------
// 2. Two Pointersç‰ˆ (ã‚³ãƒ”ãƒ¼ãªã—)
// ----------------------------------------------------
function testTwoPointers(s) {
  const startMem = process.memoryUsage().heapUsed;

  let left = 0;
  let right = s.length - 1;

  // ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ
  while (left < right) {
    // æ–‡å­—åˆ—ç”Ÿæˆã‚‚é…åˆ—ç”Ÿæˆã‚‚ã—ãªã„
    left++;
    right--;
  }

  const currentMem = process.memoryUsage().heapUsed;
  return currentMem - startMem;
}

// ----------------------------------------------------
// å®Ÿè¡Œã¨çµæœè¡¨ç¤º
// ----------------------------------------------------
console.log("ğŸ”¥ ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ (Node.js)");
console.log(`ğŸ“ æ–‡å­—åˆ—ã‚µã‚¤ã‚º: ${heavyString.length.toLocaleString()} æ–‡å­—`);
console.log("--------------------------------------------------");

// GCã®å½±éŸ¿ã‚’é¿ã‘ã‚‹ãŸã‚ã€ãã‚Œãã‚Œåˆ¥ç’°å¢ƒã§æ¸¬ã‚‹ã®ãŒç†æƒ³ã§ã™ãŒã€
// ç°¡æ˜“çš„ã«ã€ŒStackç‰ˆã€ã‚’å…ˆã«æ¸¬ã‚Šã¾ã™ã€‚

// ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¼·åˆ¶å®Ÿè¡Œã§ãã‚Œã°ãƒ™ã‚¹ãƒˆã§ã™ãŒã€
// é€šå¸¸ã®nodeå®Ÿè¡Œã§ã¯ã§ããªã„ãŸã‚ã€å·®åˆ†ã§åˆ¤æ–­ã—ã¾ã™ã€‚

const memoryDiffStack = testStack(heavyString);
// ãƒã‚¤ãƒˆ -> MBå¤‰æ›
const mbStack = (memoryDiffStack / 1024 / 1024).toFixed(2);

console.log(`[Stackç‰ˆ]`);
console.log(`å¢—ãˆãŸãƒ¡ãƒ¢ãƒª: ç´„ ${mbStack} MB`);
console.log(`(è§£èª¬: å…ƒã®æ–‡å­—åˆ—ã®ã‚³ãƒ”ãƒ¼ + é…åˆ—ç”Ÿæˆã§ãƒ¡ãƒ¢ãƒªã‚’æ¶ˆè²»)`);

console.log("--------------------------------------------------");

const memoryDiffOpt = testTwoPointers(heavyString);
const mbOpt = (memoryDiffOpt / 1024 / 1024).toFixed(2);

console.log(`[Two Pointersç‰ˆ]`);
console.log(`å¢—ãˆãŸãƒ¡ãƒ¢ãƒª: ç´„ ${mbOpt} MB`);
console.log(`(è§£èª¬: ã»ã¼ã‚¼ãƒ­ã«è¿‘ã„æ•°å€¤ã«ãªã‚‹ã¯ãš)`);

console.log("--------------------------------------------------");
